<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>DOM-based test cases — Link manipulation</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <link rel="stylesheet" href="./css/style.css" type="text/css" />

  <!-- External scripts -->
  <script src="js/sources.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="js/link_manipulation/link_manipulation.js"></script>

  <script src="js/summary.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', updateSummary);
  </script>

</head>

<body>
  <div class="container">
    <div class="topbar">
      <a class="back" href="index.html">← Back to index</a>
      <h1 class="title">DOM-based test cases — Link manipulation</h1>
    </div>
    <div class="summary">
      <span class="badge b-hi">High: <strong id="count-high">0</strong></span>
      <span class="badge b-med">Medium: <strong id="count-medium">0</strong></span>
      <span class="badge b-lo">Low: <strong id="count-low">0</strong></span>
      <span class="badge b-safe">Safe: <strong id="count-safe">0</strong></span>
      <span class="badge b-total">Total: <strong id="count-total">0</strong></span>
    </div>
    <p class="meta">These scenarios focus on attacker-controlled values influencing anchor attributes. No helpers beyond a single minimal script.</p>

    <div class="card">
      <div class="card-meta"><strong>Preview link</strong></div>
      <div class="preview">
        <span>Link:</span>
        <a id="link-preview" href="#" target="_self">#</a>
      </div>
      <div class="log" id="link-log">Awaiting events…</div>
    </div>

    <!-- Inline scenarios -->
    <h2 class="section-title">Inline scenarios</h2>
    <div class="grid">

      <div class="card" data-severity="high, low" id="il-1">
        <div class="card-meta">INLINE-1 (High): <code>href</code> set directly from <code>location.hash</code> (supports <code>javascript:</code>)</div>
        <pre>// inline-script[#1]
(function(){
  if (!location.hash) return;
  var raw = location.hash.slice(1);
  try { raw = decodeURIComponent(raw); } catch (err) {}
  linkCases.setLink('link-preview', raw, 'Set from hash');
})();</pre>
        <script>
          (function() {
            if (!location.hash) return;
            var raw = location.hash.slice(1);
            try {
              raw = decodeURIComponent(raw);
            } catch (err) {}
            linkCases.setLink('link-preview', raw, 'Set from hash');
          })();
        </script>
      </div>

      <div class="card" data-severity="high, low" id="il-2">
        <div class="card-meta">INLINE-2 (High): Query parameter appended without validation</div>
        <pre>// inline-script[#2]
(function(){
  var params = new URLSearchParams(location.search);
  var dest = params.get('link');
  if (!dest) return;
  var href = '/go?next=' + dest;
  linkCases.setLink('link-preview', href, 'Set from query');
})();</pre>
        <script>
          (function() {
            var params = new URLSearchParams(location.search);
            var dest = params.get('link');
            if (!dest) return;
            var href = '/go?next=' + dest;
            linkCases.setLink('link-preview', href, 'Set from query');
          })();
        </script>
      </div>

      <div class="card" data-severity="high, low" id="il-3">
        <div class="card-meta">INLINE-3 (High): Form <code>action</code> without <code>validation</code></div>
        <pre>// inline-script[#3]
(function(){
  var form = document.getElementById('form');
  if (!form) return;
  form.setAttribute('action', getCookieByName('form_action'));
})();</pre>
        <script>
          (function() {
            var form = document.getElementById('form');
            if (!form) return;
            form.setAttribute('action', getCookieByName('form_action'));
          })();
        </script>
      </div>



      <div class="card" data-severity="high, low" id="jq-1">
        <div class="card-meta">JQUERY-1 (High): jQuery <code>attr()</code> sets <code>href</code> from <code>returnUrl</code> param</div>
        <div class="preview">
          <span>jQuery link:</span>
          <a id="jq-link-preview" href="#">#</a>
        </div>
        <pre>// inline-script[#5]
$(function(){
  var params = new URLSearchParams(window.location.search);
  var returnUrl = params.get('returnUrl');
  if (!returnUrl) return;
  $('#jq-link-preview').attr('href', returnUrl);
});</pre>
        <script>
          $(function() {
            var params = new URLSearchParams(window.location.search);
            var returnUrl = params.get('returnUrl');
            if (!returnUrl) return;
            $('#jq-link-preview').attr('href', returnUrl);
          });
        </script>
      </div>

    </div>

    <!-- Buttons / external triggers -->
    <h2 class="section-title">Simple triggers</h2>
    <div class="card">
      <div class="card-meta"><strong>Buttons feed the same link preview</strong></div>
      <pre data-severity="high">onclick="linkCases.setLink('link-preview', document.getElementById('user_link').value, 'Set from field')</pre>
      <div class="controls">
        <input id="user_link" type="text" value="javascript:alert('click')" />
        <button class="btn" type="button" onclick="linkCases.setLink('link-preview', document.getElementById('user_link').value, 'Set from field')">Use field</button>
      </div>
      <pre data-severity="high">linkCases.setLink('link-preview', linkCases.getLocal(), 'Set from localStorage')</pre>
      <div class="controls">
        <button class="btn" type="button" onclick="linkCases.setLink('link-preview', linkCases.getLocal(), 'Set from localStorage')">Use localStorage</button>
      </div>
      <pre data-severity="high">onclick="linkCases.setLink('link-preview', linkCases.getCookie(), 'Set from cookie')"</pre>
      <div class="controls">
        <button class="btn" type="button" onclick="linkCases.setLink('link-preview', linkCases.getCookie(), 'Set from cookie')">Use cookie</button>
      </div>
    </div>

    <footer>PTK SAST testbed — Link manipulation. <a class="back" href="index.html">Back to index</a></footer>
  </div>

</body>

</html>