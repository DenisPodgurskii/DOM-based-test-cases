<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>DOM-based test cases — Open Redirects</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="./css/style.css" type="text/css" />
  <!-- External scripts -->
  <script src="js/open_redirect/open_redirect_sink.js"></script>
  <script src="js/open_redirect/open_redirect_external_sources.js"></script>

  <script src="js/summary.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', updateSummary);
  </script>
  <script>
    function setHashPayload() {
      const payload = "https://attacker.example/redirect?from=hash";
      location.hash = encodeURIComponent(payload);
    }
  </script>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <a class="back" href="index.html">← Back to index</a>
      <h1 class="title">DOM-based test cases — Open Redirect sinks</h1>
    </div>
    <div class="summary">
      <span class="badge b-hi">High: <strong id="count-high">0</strong></span>
      <span class="badge b-med">Medium: <strong id="count-medium">0</strong></span>
      <span class="badge b-lo">Low: <strong id="count-low">0</strong></span>
      <span class="badge b-safe">Safe: <strong id="count-safe">0</strong></span>
      <span class="badge b-total">Total: <strong id="count-total">0</strong></span>
    </div>
    <p class="meta">These fixtures target DOM-based open redirect flows. The default sink uses <code class="inline">window.open</code>; uncomment hooks inside <code class="inline">openRedirectSink</code> for full navigation if desired.</p>

    <div class="controls">
      <a class="btn secondary" href="?payload=https%3A%2F%2Fattacker.example%2Fquery">Use query payload</a>
      <button class="btn secondary" type="button" onclick="setHashPayload()">Set hash payload</button>
    </div>

    <!-- Inline scenarios -->
    <h2 class="section-title">Inline scenarios</h2>
    <div class="grid">

      <div class="card" data-severity="high" id="il-1" >
        <div class="card-meta" >INLINE-1 (High): Query/hash → <code class="inline">openRedirectSink</code></div>
        <pre>// inline-script[#1]
(function(){
  function redirect(url) {
    if (!url) return;
    openRedirectSink(url, 'inline-open-log');
  }
  const params = new URLSearchParams(location.search);
  if (params.has('payload')) redirect(params.get('payload'));
  if (location.hash) {
    try { redirect(decodeURIComponent(location.hash.slice(1))); }
    catch (err) { redirect(location.hash.slice(1)); }
  }
  window.addEventListener('hashchange', () => {
    if (!location.hash) return;
    try { redirect(decodeURIComponent(location.hash.slice(1))); }
    catch (err) { redirect(location.hash.slice(1)); }
  });
})();</pre>
        <div class="log" id="inline-open-log">Open redirect log…</div>
        <script>
          (function() {
            function redirect(url) {
              if (!url) return;
              openRedirectSink(url, 'inline-open-log');
            }
            const params = new URLSearchParams(location.search);
            if (params.has('payload')) redirect(params.get('payload'));
            if (location.hash) {
              try {
                redirect(decodeURIComponent(location.hash.slice(1)));
              } catch (err) {
                redirect(location.hash.slice(1));
              }
            }
            window.addEventListener('hashchange', () => {
              if (!location.hash) return;
              try {
                redirect(decodeURIComponent(location.hash.slice(1)));
              } catch (err) {
                redirect(location.hash.slice(1));
              }
            });
          })();
        </script>
      </div>

      <div class="card" data-severity="high, low" id="il-2">
        <div class="card-meta">INLINE-2 (High): Field → <code class="inline">openRedirectSink</code></div>
        <pre>// inline-script[#2]
function inlineOpenRedirect(fieldId, logId) {
  const el = document.getElementById(fieldId);
  if (!el) return;
  openRedirectSink(el.value, logId);
}</pre>
        <div class="field">
          <input id="inline_open_payload" type="text" value="https://attacker.example/inline" />
          <button class="btn" type="button" onclick="inlineOpenRedirect('inline_open_payload', 'inline-open-log')">Redirect inline field</button>
        </div>
        <script>
          function inlineOpenRedirect(fieldId, logId) {
            const el = document.getElementById(fieldId);
            if (!el) return;
            openRedirectSink(el.value, logId);
          }
        </script>
      </div>

      <div class="card" data-severity="safe, low" id="il-3">
        <div class="card-meta">INLINE-3 (Safe): Same-origin enforcement</div>
        <pre>// inline-script[#3]
(function(){
  const params = new URLSearchParams(location.search);
  const url = params.get('safe');
  if (!url) return;
  const res = openRedirectUtils.sameOriginGuard(url);
  document.getElementById('inline-safe-open').textContent = res.message;
})();</pre>
        <div class="output" id="inline-safe-open">Waiting for payload…</div>
        <script>
          (function() {
            const params = new URLSearchParams(location.search);
            const url = params.get('safe');
            if (!url) return;
            const res = openRedirectUtils.sameOriginGuard(url);
            const target = document.getElementById('inline-safe-open');
            if (target) target.textContent = res.message;
          })();
        </script>
      </div>

    </div>

    <!-- External scenarios -->
    <h2 class="section-title">External scenarios (click to run)</h2>
    <div class="grid">

      <div class="card">
        <div class="card-meta"><strong>Direct DOM sources</strong></div>
        <pre data-severity="high">onclick="extOpenRedirectFromHash()"</pre>
        <div class="controls">
          <button class="btn" data-severity="high" type="button" onclick="extOpenRedirectFromHash()">EXT: location.hash</button>
        </div>
        <pre data-severity="high">onclick="extOpenRedirectFromSearch()"</pre>
        <div class="controls">
          <button class="btn" data-severity="high" type="button" onclick="extOpenRedirectFromSearch()">EXT: URLSearchParams</button>
        </div>
        <pre data-severity="high">onclick="extOpenRedirectFromWindowName()"</pre>
        <div class="controls">
          <button class="btn" type="button" onclick="extOpenRedirectFromWindowName()">EXT: window.name</button>
        </div>
        <pre data-severity="high">onclick="extOpenRedirectFromReferrer()"</pre>
        <div class="controls">
          <button class="btn" type="button" onclick="extOpenRedirectFromReferrer()">EXT: document.referrer</button>
        </div>

        <pre data-severity="high">onclick="extOpenRedirectFromCookie()"</pre>
        <div class="controls">
          <button class="btn" type="button" onclick="extOpenRedirectFromCookie()">EXT: document.cookie</button>
        </div>
        <pre data-severity="high">onclick="extOpenRedirectFromLocalStorage()"</pre>
        <div class="controls">
          <button class="btn" type="button" onclick="extOpenRedirectFromLocalStorage()">EXT: localStorage</button>
        </div>
        <pre data-severity="high">onclick="extOpenRedirectFromSessionStorage()"</pre>
        <div class="controls">
          <button class="btn" type="button" onclick="extOpenRedirectFromSessionStorage()">EXT: sessionStorage</button>
        </div>
      </div>

    </div>

    <footer>PTK SAST testbed — Open Redirect sinks (inline + external). <a class="back" href="index.html">Back to index</a></footer>
  </div>


</body>

</html>