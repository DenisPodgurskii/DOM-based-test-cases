<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>DOM-based test cases — eval()</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="./css/style.css" type="text/css" />


  <!-- External script includes -->
  <script src="js/sources.js"></script>
  <script src="js/eval/eval_sink.js"></script>
  <script src="js/eval/eval_external_sources.js"></script>
  <script src="js/summary.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', updateSummary);
  </script>
  <script>
    // helper to inject a sample hash payload without reloading
    function setHashPayload() {
      const sample = "alert('hash-inline')";
      location.hash = encodeURIComponent(sample);
    }
  </script>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <a class="back" href="index.html">← Back to index</a>
      <h1 class="title">DOM-based test cases — <code>eval</code> family sinks</h1>
    </div>
    <div class="summary">
      <span class="badge b-hi">High: <strong id="count-high">0</strong></span>
      <span class="badge b-med">Medium: <strong id="count-medium">0</strong></span>
      <span class="badge b-lo">Low: <strong id="count-low">0</strong></span>
      <span class="badge b-safe">Safe: <strong id="count-safe">0</strong></span>
      <span class="badge b-total">Total: <strong id="count-total">0</strong></span>
    </div>
    <p class="meta">This page mixes inline <code class="inline">eval</code>-style sinks with external helper scripts. Inline scenarios execute automatically; external ones are opt-in via buttons.</p>

    <div class="controls">
      <a class="btn secondary" href="?payload=alert(1)">Use query payload</a>
      <button class="btn secondary" type="button" onclick="setHashPayload()">Set hash payload</button>
    </div>

    <!-- Inline scenarios -->
    <h2 class="section-title">Inline scenarios</h2>
    <div class="grid">

      <div class="card" data-severity="high, low" id="il-1">
        <div class="card-meta">INLINE-1 (High): Direct hash → <code class="inline">eval()</code></div>
        <pre>// inline-script[#1]
(function(){
  function run() {
    if (!location.hash) return;
    var raw = location.hash.slice(1);
    var payload;
    try { payload = decodeURIComponent(raw); }
    catch (err) { payload = raw; }
    if (payload) eval(payload);
  }
  run();
  window.addEventListener('hashchange', run);
})();</pre>
        <script>
          (function() {
            function run() {
              if (!location.hash) return;
              var raw = location.hash.slice(1);
              var payload;
              try {
                payload = decodeURIComponent(raw);
              } catch (err) {
                payload = raw;
              }
              if (payload) eval(payload);
            }
            run();
            window.addEventListener('hashchange', run);
          })();
        </script>
      </div>

      <div class="card" data-severity="high, low" id="il-2">
        <div class="card-meta">INLINE-2 (High): Query param <code class="inline">payload</code> → <code class="inline">eval()</code></div>
        <pre>// inline-script[#2]
(function(){
  var params = new URLSearchParams(location.search);
  var payload = params.get('payload');
  if (payload) {
    eval(payload);
  }
})();</pre>
        <script>
          (function() {
            var params = new URLSearchParams(location.search);
            var payload = params.get('payload');
            if (payload) {
              eval(payload);
            }
          })();
        </script>
      </div>

      <div class="card" data-severity="high, low" id="il-3">
        <div class="card-meta">INLINE-3 (High): User-provided field → <code class="inline">eval()</code></div>
        <pre>// inline-script[#3]
function inlineEvalFromField(fieldId) {
  var el = document.getElementById(fieldId);
  if (!el) return;
  eval(el.value);
}</pre>
        <div class="field">
          <input id="inline_eval_payload" type="text" value="alert('inline-field')" />
          <button class="btn" type="button" onclick="inlineEvalFromField('inline_eval_payload')">Run inline eval(field)</button>
        </div>
        <script>
          function inlineEvalFromField(fieldId) {
            var el = document.getElementById(fieldId);
            if (!el) return;
            eval(el.value);
          }
        </script>
      </div>

      <div class="card" data-severity="safe, medium" id="il-4">
        <div class="card-meta">INLINE-4 (Safe): JSON allowlist instead of <code class="inline">eval</code></div>
        <pre>// inline-script[#4]
(function(){
  var params = new URLSearchParams(location.search);
  var payload = params.get('calc');
  if (!payload) return;
  try {
    var parsed = JSON.parse(payload);
    var allowed = {
      add: function(a,b){ return Number(a) + Number(b); },
      ping: function(){ return "pong"; }
    };
    var fn = allowed[parsed.fn];
    var args = Array.isArray(parsed.args) ? parsed.args : [];
    if (typeof fn === 'function') {
      var result = fn.apply(null, args);
      document.getElementById('safe-inline-result').textContent = String(result);
    }
  } catch (err) {
    document.getElementById('safe-inline-result').textContent = "Rejected";
  }
})();</pre>
        <div class="meta">Pass <code class="inline">?calc={"fn":"add","args":[2,5]}</code> to see the result rendered below.</div>
        <div class="output" id="safe-inline-result">Awaiting payload…</div>
        <script>
          (function() {
            var params = new URLSearchParams(location.search);
            var payload = params.get('calc');
            if (!payload) return;
            try {
              var parsed = JSON.parse(payload);
              var allowed = {
                add: function(a, b) {
                  return Number(a) + Number(b);
                },
                ping: function() {
                  return "pong";
                }
              };
              var fn = allowed[parsed.fn];
              var args = Array.isArray(parsed.args) ? parsed.args : [];
              if (typeof fn === 'function') {
                var result = fn.apply(null, args);
                document.getElementById('safe-inline-result').textContent = String(result);
              }
            } catch (err) {
              document.getElementById('safe-inline-result').textContent = "Rejected";
            }
          })();
        </script>
      </div>

      <div class="card" data-severity="high, low" id="il-2">
        <div class="card-meta">INLINE-5 (High): Query param <code class="inline">payload</code> → <code class="inline">eval()</code></div>
        <pre>// inline-script[#2]
(function(){
  var params = new URLSearchParams(location.search);
  var payload = params.get('payload');
  if (payload) {
    evalSink(payload,'evalSink');
  }
})();</pre>
        <script>
          (function() {
            var params = new URLSearchParams(location.search);
            var payload = params.get('payload');
            if (payload) {
              evalSink(payload, 'evalSink');
            }
          })();
        </script>
      </div>

    </div>

    <!-- External scenarios -->
    <h2 class="section-title">External scenarios (click to run)</h2>
    <div class="grid">

      <div class="card">
        <div class="card-meta"><strong>Direct DOM sources → eval()</strong></div>
        <pre data-severity="high, low">onclick="extEvalFromHash()"</pre>
        <div class="controls">
          <button class="btn" type="button" onclick="extEvalFromHash()">EXT: location.hash</button>
        </div>
        <pre data-severity="high, low">onclick="extEvalFromSearch()"</pre>
        <div class="controls">
          <button class="btn" type="button" onclick="extEvalFromSearch()">EXT: URLSearchParams</button>
        </div>
        <pre data-severity="high">onclick="extEvalFromWindowName()"</pre>
        <div class="controls">
          <button class="btn" type="button" onclick="extEvalFromWindowName()">EXT: window.name</button>
        </div>
        <pre data-severity="high">onclick="extEvalFromReferrer()"</pre>
        <div class="controls">
          <button class="btn" type="button" onclick="extEvalFromReferrer()">EXT: document.referrer</button>
        </div>
        <pre data-severity="high">onclick="extEvalFromCookie()"</pre>
        <div class="controls">
          <button class="btn" type="button" onclick="extEvalFromCookie()">EXT: document.cookie</button>
        </div>
        <pre data-severity="high">onclick="extEvalFromLocalStorage()"</pre>
        <div class="controls">
          <button class="btn" type="button" onclick="extEvalFromLocalStorage()">EXT: localStorage</button>
        </div>
        <pre data-severity="high">onclick="extEvalFromSessionStorage()"</pre>
        <div class="controls">
          <button class="btn" type="button" onclick="extEvalFromSessionStorage()">EXT: sessionStorage</button>
        </div>
        <p class="meta">Implementations live in <code class="inline">js/eval/eval_external_sources.js</code>.</p>
      </div>





    </div>

    <footer>PTK SAST testbed — eval() family (inline + external). <a class="back" href="index.html">Back to index</a></footer>
  </div>

</body>

</html>